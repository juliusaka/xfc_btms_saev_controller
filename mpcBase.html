<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>mpc base</title>
  <style>
    html {
      line-height: 1.5;
      font-family: Georgia, serif;
      font-size: 20px;
      color: #1a1a1a;
      background-color: #fdfdfd;
    }
    body {
      margin: 0 auto;
      max-width: 36em;
      padding-left: 50px;
      padding-right: 50px;
      padding-top: 50px;
      padding-bottom: 50px;
      hyphens: auto;
      word-wrap: break-word;
      text-rendering: optimizeLegibility;
      font-kerning: normal;
    }
    @media (max-width: 600px) {
      body {
        font-size: 0.9em;
        padding: 1em;
      }
    }
    @media print {
      body {
        background-color: transparent;
        color: black;
        font-size: 12pt;
      }
      p, h2, h3 {
        orphans: 3;
        widows: 3;
      }
      h2, h3, h4 {
        page-break-after: avoid;
      }
    }
    p {
      margin: 1em 0;
    }
    a {
      color: #1a1a1a;
    }
    a:visited {
      color: #1a1a1a;
    }
    img {
      max-width: 100%;
    }
    h1, h2, h3, h4, h5, h6 {
      margin-top: 1.4em;
    }
    h5, h6 {
      font-size: 1em;
      font-style: italic;
    }
    h6 {
      font-weight: normal;
    }
    ol, ul {
      padding-left: 1.7em;
      margin-top: 1em;
    }
    li > ol, li > ul {
      margin-top: 0;
    }
    blockquote {
      margin: 1em 0 1em 1.7em;
      padding-left: 1em;
      border-left: 2px solid #e6e6e6;
      color: #606060;
    }
    code {
      font-family: Menlo, Monaco, 'Lucida Console', Consolas, monospace;
      font-size: 85%;
      margin: 0;
    }
    pre {
      margin: 1em 0;
      overflow: auto;
    }
    pre code {
      padding: 0;
      overflow: visible;
    }
    .sourceCode {
     background-color: transparent;
     overflow: visible;
    }
    hr {
      background-color: #1a1a1a;
      border: none;
      height: 1px;
      margin: 1em 0;
    }
    table {
      margin: 1em 0;
      border-collapse: collapse;
      width: 100%;
      overflow-x: auto;
      display: block;
      font-variant-numeric: lining-nums tabular-nums;
    }
    table caption {
      margin-bottom: 0.75em;
    }
    tbody {
      margin-top: 0.5em;
      border-top: 1px solid #1a1a1a;
      border-bottom: 1px solid #1a1a1a;
    }
    th {
      border-top: 1px solid #1a1a1a;
      padding: 0.25em 0.5em 0.25em 0.5em;
    }
    td {
      padding: 0.125em 0.5em 0.25em 0.5em;
    }
    header {
      margin-bottom: 4em;
      text-align: center;
    }
    #TOC li {
      list-style: none;
    }
    #TOC a:not(:hover) {
      text-decoration: none;
    }
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    span.underline{text-decoration: underline;}
    div.column{display: inline-block; vertical-align: top; width: 50%;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
  </style>
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
</head>
<body>
<header id="title-block-header">
<h1 class="title">mpc base</h1>
</header>
<h1 id="mpc-base">MPC Base</h1>
<h2 id="three-level-approach">three level approach</h2>
<ol type="1">
<li>Level: economical optimization (sizing) of BTMS-size
<ul>
<li>for unconstrained case, i.e. all cars are charged immediatly.</li>
<li>Can apply before level 2 a factor to decrease the BTMS size, as this size should be seen as an upper limit, where charging of vehicle isn’t decreased.</li>
</ul></li>
<li>Level: optimal long-term/day-ahead plan for charging</li>
<li>Level: real-time trajectory following MPC algorithm</li>
</ol>
<h2 id="level-economical-optimization-of-btms-size">1. Level: Economical Optimization of BTMS-Size</h2>
<p>in <em>determineBtmsSize()</em>:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>min</mo><mspace width="1.0em"></mspace><mi>a</mi><mo>⋅</mo><mo stretchy="false" form="prefix">(</mo><msub><mi>P</mi><mrow><mi>s</mi><mi>l</mi><mi>a</mi><mi>c</mi><mi>k</mi></mrow></msub><mo>−</mo><msub><mi>P</mi><mrow><mi>f</mi><mi>r</mi><mi>e</mi><mi>e</mi></mrow></msub><mo stretchy="false" form="postfix">)</mo><mo>+</mo><mi>b</mi><mo>⋅</mo><msubsup><mi>Σ</mi><mrow><mi>k</mi><mo>=</mo><mn>0</mn></mrow><mi>T</mi></msubsup><msub><mi>P</mi><mrow><mi>B</mi><mi>T</mi><mi>M</mi><mi>S</mi><mo>,</mo><mi>C</mi><mi>h</mi></mrow></msub><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo><mi>d</mi><mi>t</mi><mo>+</mo><mi>c</mi><mo>⋅</mo><mo stretchy="false" form="prefix">(</mo><msubsup><mi>Σ</mi><mrow><mi>k</mi><mo>=</mo><mn>0</mn></mrow><mrow><mi>k</mi><mo>=</mo><mi>T</mi></mrow></msubsup><msub><mi>P</mi><mrow><mi>B</mi><mi>T</mi><mi>M</mi><mi>S</mi><mo>,</mo><mi>C</mi><mi>h</mi></mrow></msub><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo><mi>d</mi><mi>t</mi><mo>+</mo><msubsup><mi>Σ</mi><mrow><mi>k</mi><mo>=</mo><mn>0</mn></mrow><mrow><mi>k</mi><mo>=</mo><mi>T</mi></mrow></msubsup><msub><mi>P</mi><mrow><mi>B</mi><mi>T</mi><mi>M</mi><mi>S</mi><mo>,</mo><mi>D</mi><mi>C</mi><mi>h</mi></mrow></msub><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo><mi>d</mi><mi>t</mi><mo stretchy="false" form="postfix">)</mo></mrow><annotation encoding="application/x-tex">\begin{equation}
\min \quad a \cdot (P_{slack} - P_{free}) + b \cdot \Sigma_{k=0}^{T} P_{BTMS,Ch}(k)dt + c \cdot (\Sigma_{k=0}^{k=T} P_{BTMS,Ch}(k)dt + \Sigma_{k=0}^{k=T}P_{BTMS,DCh}(k)dt)
\end{equation}</annotation></semantics></math> subject to: <math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable><mtr><mtd columnalign="right"><msub><mi>E</mi><mrow><mi>B</mi><mi>T</mi><mi>M</mi><mi>S</mi></mrow></msub><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo>+</mo><mn>1</mn><mo stretchy="false" form="postfix">)</mo></mtd><mtd columnalign="left"><mo>=</mo><msub><mi>E</mi><mrow><mi>B</mi><mi>T</mi><mi>M</mi><mi>S</mi></mrow></msub><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo><mo>+</mo><mi>d</mi><mi>t</mi><mo>⋅</mo><mo stretchy="false" form="prefix">(</mo><mi>η</mi><mo>⋅</mo><msub><mi>P</mi><mrow><mi>B</mi><mi>T</mi><mi>M</mi><mi>S</mi><mo>,</mo><mi>C</mi><mi>h</mi></mrow></msub><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo><mo>+</mo><mfrac><mn>1</mn><mi>η</mi></mfrac><msub><mi>P</mi><mrow><mi>B</mi><mi>T</mi><mi>M</mi><mi>S</mi><mo>,</mo><mi>D</mi><mi>C</mi><mi>h</mi></mrow></msub><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo><mo stretchy="false" form="postfix">)</mo><mspace width="1.0em"></mspace></mtd><mtd columnalign="right"><mo>∀</mo><mi>k</mi><mo>∈</mo><mo stretchy="false" form="prefix">[</mo><mn>0</mn><mo>,</mo><mi>T</mi><mo stretchy="false" form="postfix">]</mo></mtd></mtr><mtr><mtd columnalign="right"><msub><mi>P</mi><mrow><mi>C</mi><mi>h</mi><mi>a</mi><mi>r</mi><mi>g</mi><mi>e</mi></mrow></msub><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo></mtd><mtd columnalign="left"><mo>=</mo><msub><mi>P</mi><mrow><mi>G</mi><mi>r</mi><mi>i</mi><mi>d</mi></mrow></msub><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo><mo>−</mo><msub><mi>P</mi><mrow><mi>B</mi><mi>T</mi><mi>M</mi><mi>S</mi></mrow></msub><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo><mspace width="1.0em"></mspace></mtd><mtd columnalign="right"><mo>∀</mo><mi>k</mi><mo>∈</mo><mo stretchy="false" form="prefix">[</mo><mn>0</mn><mo>,</mo><mi>T</mi><mo stretchy="false" form="postfix">]</mo></mtd></mtr><mtr><mtd columnalign="right"><msub><mi>P</mi><mrow><mi>B</mi><mi>T</mi><mi>M</mi><mi>S</mi></mrow></msub><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo></mtd><mtd columnalign="left"><mo>=</mo><msub><mi>P</mi><mrow><mi>B</mi><mi>T</mi><mi>M</mi><mi>S</mi><mo>,</mo><mi>C</mi><mi>h</mi></mrow></msub><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo><mo>+</mo><msub><mi>P</mi><mrow><mi>B</mi><mi>T</mi><mi>M</mi><mi>S</mi><mo>,</mo><mi>D</mi><mi>C</mi><mi>h</mi></mrow></msub><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo><mspace width="1.0em"></mspace></mtd><mtd columnalign="right"><mo>∀</mo><mi>k</mi><mo>∈</mo><mo stretchy="false" form="prefix">[</mo><mn>0</mn><mo>,</mo><mi>T</mi><mo stretchy="false" form="postfix">]</mo></mtd></mtr><mtr><mtd columnalign="right"><msub><mi>P</mi><mrow><mi>B</mi><mi>T</mi><mi>M</mi><mi>S</mi><mo>,</mo><mi>C</mi><mi>h</mi></mrow></msub><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo></mtd><mtd columnalign="left"><mo>≥</mo><mn>0</mn><mspace width="1.0em"></mspace></mtd><mtd columnalign="right"><mo>∀</mo><mi>k</mi><mo>∈</mo><mo stretchy="false" form="prefix">[</mo><mn>0</mn><mo>,</mo><mi>T</mi><mo stretchy="false" form="postfix">]</mo></mtd></mtr><mtr><mtd columnalign="right"><msub><mi>P</mi><mrow><mi>B</mi><mi>T</mi><mi>M</mi><mi>S</mi><mo>,</mo><mi>D</mi><mi>C</mi><mi>h</mi></mrow></msub><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo></mtd><mtd columnalign="left"><mo>≤</mo><mn>0</mn><mspace width="1.0em"></mspace></mtd><mtd columnalign="right"><mo>∀</mo><mi>k</mi><mo>∈</mo><mo stretchy="false" form="prefix">[</mo><mn>0</mn><mo>,</mo><mi>T</mi><mo stretchy="false" form="postfix">]</mo></mtd></mtr><mtr><mtd columnalign="right"><msub><mi>E</mi><mrow><mi>B</mi><mi>T</mi><mi>M</mi><mi>S</mi></mrow></msub><mo stretchy="false" form="prefix">(</mo><mn>0</mn><mo stretchy="false" form="postfix">)</mo></mtd><mtd columnalign="left"><mo>=</mo><msub><mi>E</mi><mrow><mi>B</mi><mi>T</mi><mi>M</mi><mi>S</mi></mrow></msub><mo stretchy="false" form="prefix">(</mo><mi>T</mi><mo>+</mo><mn>1</mn><mo stretchy="false" form="postfix">)</mo></mtd></mtr><mtr><mtd columnalign="right"><msub><mi>E</mi><mrow><mi>B</mi><mi>T</mi><mi>M</mi><mi>S</mi></mrow></msub><mo stretchy="false" form="prefix">(</mo><mn>0</mn><mo stretchy="false" form="postfix">)</mo></mtd><mtd columnalign="left"><mo>=</mo><mn>0</mn></mtd></mtr><mtr><mtd columnalign="right"><msub><mi>P</mi><mrow><mi>s</mi><mi>l</mi><mi>a</mi><mi>c</mi><mi>k</mi></mrow></msub></mtd><mtd columnalign="left"><mo>≥</mo><mo>max</mo><mo stretchy="false" form="prefix">(</mo><msub><mi>P</mi><mrow><mi>G</mi><mi>r</mi><mi>i</mi><mi>d</mi></mrow></msub><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo><mo stretchy="false" form="postfix">)</mo></mtd></mtr><mtr><mtd columnalign="right"><msub><mi>P</mi><mrow><mi>s</mi><mi>l</mi><mi>a</mi><mi>c</mi><mi>k</mi></mrow></msub></mtd><mtd columnalign="left"><mo>≥</mo><msub><mi>P</mi><mrow><mi>f</mi><mi>r</mi><mi>e</mi><mi>e</mi></mrow></msub></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{align}
E_{BTMS}(k+1) &amp;= E_{BTMS}(k) + dt \cdot (\eta \cdot P_{BTMS,Ch}(k) + \frac{1}{\eta}P_{BTMS,DCh}(k)) \quad &amp;\forall k \in [0,T]\\
P_{Charge}(k) &amp;= P_{Grid}(k) - P_{BTMS}(k) \quad &amp;\forall k \in [0,T]  \\
P_{BTMS}(k) &amp;= P_{BTMS,Ch}(k) + P_{BTMS,DCh}(k) \quad &amp;\forall k \in [0,T]\\
P_{BTMS,Ch}(k) &amp;\geq 0 \quad &amp;\forall k \in [0,T]\\
P_{BTMS,DCh}(k) &amp;\leq 0 \quad &amp;\forall k \in [0,T]\\
E_{BTMS}(0) &amp;= E_{BTMS}(T+1)\\
E_{BTMS}(0) &amp;= 0\\
P_{slack} &amp;\geq \max(P_{Grid}(k))\\
P_{slack} &amp;\geq P_{free}
\end{align}</annotation></semantics></math></p>
<p>where <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>a</mi><annotation encoding="application/x-tex">a</annotation></semantics></math> is the demand charge per day, <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>b</mi><annotation encoding="application/x-tex">b</annotation></semantics></math> is the BTMS cost per cycle per kWh and c is the electricity cost. <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>P</mi><mrow><mi>G</mi><mi>r</mi><mi>i</mi><mi>d</mi></mrow></msub><annotation encoding="application/x-tex">P_{Grid}</annotation></semantics></math> is the power withdrawal from the electric grid, <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>P</mi><mrow><mi>B</mi><mi>T</mi><mi>M</mi><mi>S</mi></mrow></msub><annotation encoding="application/x-tex">P_{BTMS}</annotation></semantics></math> is the power to/from the behind the meter storage and <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>P</mi><mrow><mi>C</mi><mi>h</mi><mi>a</mi><mi>r</mi><mi>g</mi><mi>e</mi></mrow></msub><annotation encoding="application/x-tex">P_{Charge}</annotation></semantics></math> is the unconstrained power flow of the charging station, which is determined in the class-method <em>generatePredictions()</em>, with a simple algorithm, considering vehicle arrivals and the maximum number of available charging bays at the charging station. <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>E</mi><mrow><mi>B</mi><mi>T</mi><mi>M</mi><mi>S</mi></mrow></msub><annotation encoding="application/x-tex">E_{BTMS}</annotation></semantics></math> is the energy content of the behind the meter storage, and its size is left open to be determined by the optimization. Under the assumption of a periodic behaviour over each day, we set the constraint $ E_{BTMS}(0) = E_{BTMS}(T+1) $ to avoid the optimization of just discharging the BTMS to reduce cost. To correctly implement charging losses, we assume that the same charging loss occurs while charging and discharge, and model these effects with two variables <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>P</mi><mrow><mi>B</mi><mi>T</mi><mi>M</mi><mi>S</mi><mo>,</mo><mi>C</mi><mi>h</mi></mrow></msub><annotation encoding="application/x-tex">P_{BTMS,Ch}</annotation></semantics></math> and <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>P</mi><mrow><mi>B</mi><mi>T</mi><mi>M</mi><mi>S</mi><mo>,</mo><mi>D</mi><mi>C</mi><mi>h</mi></mrow></msub><annotation encoding="application/x-tex">P_{BTMS,DCh}</annotation></semantics></math>, please see remark at bottom for a further explanation of this.</p>
<p>The objective is to minimize the sum of demand charge, the usage cost of the BTMS as the cost of storing/releasing energy in terms of cycles and the energy loss cost. As demand charges can be applied after exceeding a certain level, we choosed a formulation which returns the exceeding of a certain power level <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>P</mi><mrow><mi>f</mi><mi>r</mi><mi>e</mi><mi>e</mi></mrow></msub><annotation encoding="application/x-tex">P_{free}</annotation></semantics></math>. The term <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>P</mi><mrow><mi>s</mi><mi>l</mi><mi>a</mi><mi>c</mi><mi>k</mi></mrow></msub><mo>−</mo><msub><mi>P</mi><mrow><mi>f</mi><mi>r</mi><mi>e</mi><mi>e</mi></mrow></msub></mrow><annotation encoding="application/x-tex">P_{slack} - P_{free}</annotation></semantics></math> is 0 as long as <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>max</mo><mo stretchy="false" form="prefix">(</mo><msub><mi>P</mi><mrow><mi>G</mi><mi>r</mi><mi>i</mi><mi>d</mi></mrow></msub><mo stretchy="false" form="postfix">)</mo><mo>≤</mo><msub><mi>P</mi><mrow><mi>f</mi><mi>r</mi><mi>e</mi><mi>e</mi></mrow></msub></mrow><annotation encoding="application/x-tex">\max(P_{Grid}) \leq P_{free}</annotation></semantics></math>, and gives after that the difference to the free power level.</p>
<p>As the problem is convex in objective function and constraints, a solution can be efficiently determined with open-source accessible solvers. We use the mathematical modeling language <em>cvxpy</em>. For the implementation, we defined the following states, control and disturbance(input) variables. We also define the slack variable for a free power level before demand charge: <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable><mtr><mtd columnalign="right"><mi>x</mi><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo></mtd><mtd columnalign="left"><mo>=</mo><mo stretchy="false" form="prefix">[</mo><msub><mi>E</mi><mrow><mi>B</mi><mi>T</mi><mi>M</mi><mi>S</mi></mrow></msub><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo><mo stretchy="false" form="postfix">]</mo></mtd></mtr><mtr><mtd columnalign="right"><mi>u</mi><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo></mtd><mtd columnalign="left"><mo>=</mo><mo stretchy="false" form="prefix">[</mo><msub><mi>P</mi><mrow><mi>G</mi><mi>r</mi><mi>i</mi><mi>d</mi></mrow></msub><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo><mo>,</mo><msub><mi>P</mi><mrow><mi>B</mi><mi>T</mi><mi>M</mi><mi>S</mi></mrow></msub><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo><mo>,</mo><msub><mi>P</mi><mrow><mi>B</mi><mi>T</mi><mi>M</mi><mi>S</mi><mo>,</mo><mi>C</mi><mi>h</mi></mrow></msub><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo><mo>,</mo><msub><mi>P</mi><mrow><mi>B</mi><mi>T</mi><mi>M</mi><mi>S</mi><mo>,</mo><mi>D</mi><mi>C</mi><mi>h</mi></mrow></msub><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo><mo stretchy="false" form="postfix">]</mo></mtd></mtr><mtr><mtd columnalign="right"><mi>i</mi><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo></mtd><mtd columnalign="left"><mo>=</mo><mo stretchy="false" form="prefix">[</mo><msub><mi>P</mi><mrow><mi>C</mi><mi>h</mi><mi>a</mi><mi>r</mi><mi>g</mi><mi>e</mi></mrow></msub><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo><mo stretchy="false" form="postfix">]</mo></mtd></mtr><mtr><mtd columnalign="right"><msub><mi>P</mi><mrow><mi>s</mi><mi>l</mi><mi>a</mi><mi>c</mi><mi>k</mi></mrow></msub></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{align} x(k) &amp;= [E_{BTMS}(k)] \\ u(k) &amp;= [P_{Grid}(k), P_{BTMS}(k), P_{BTMS,Ch}(k), P_{BTMS,DCh}(k)] \\ i(k) &amp;= [P_{Charge}(k)]\\ P_{slack} \end{align}</annotation></semantics></math></p>
<p>With this formulization, the BTMS-size is determined as <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>max</mo><mo stretchy="false" form="prefix">(</mo><msub><mi>E</mi><mrow><mi>B</mi><mi>T</mi><mi>M</mi><mi>S</mi></mrow></msub><mo stretchy="false" form="postfix">)</mo><mo>−</mo><mo>min</mo><mo stretchy="false" form="prefix">(</mo><msub><mi>E</mi><mrow><mi>B</mi><mi>T</mi><mi>M</mi><mi>S</mi></mrow></msub><mo stretchy="false" form="postfix">)</mo></mrow><annotation encoding="application/x-tex">\max(E_{BTMS}) - \min(E_{BTMS})</annotation></semantics></math>. The maximum power delivery of the BTMS is unconstrained and can therefore reach high C-Ratings, especially when you choose high BTMS cycle cost compared to demand charges. Integrating a C-Rating into this optimization problem leads to a non-convex formulization which would have to be solved with a less efficient solver and isn’t guarenteed to be globally optimal. As we try to assess future scenarios, higher C-ratings are probably possible, so that this shouldn’t be off to much concern for us.</p>
<p>After determining the BTMS-size for unconstrained charging, it is possible to reduce the size to e.g. assess the impact of this on SAEV-fleets.</p>
<h3 id="correct-implementation-of-charging-losses">correct implementation of charging losses</h3>
<p>You might assume that the equation for the dynamics of the energy content is <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>E</mi><mrow><mi>B</mi><mi>T</mi><mi>M</mi><mi>S</mi></mrow></msub><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo>+</mo><mn>1</mn><mo stretchy="false" form="postfix">)</mo><mo>=</mo><mi>E</mi><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo><mo>+</mo><mi>d</mi><mi>t</mi><mo>⋅</mo><mi>η</mi><mo>⋅</mo><msub><mi>P</mi><mrow><mi>B</mi><mi>T</mi><mi>M</mi><mi>S</mi></mrow></msub><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo></mrow><annotation encoding="application/x-tex">\begin{equation} E_{BTMS}(k+1) = E(k) + dt \cdot \eta \cdot P_{BTMS}(k) \end{equation}</annotation></semantics></math> when charging for k=0 and discharging for k=1, and assuming that the energy level should be the same after this operation (<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>E</mi><mrow><mi>B</mi><mi>T</mi><mi>M</mi><mi>S</mi></mrow></msub><mo stretchy="false" form="prefix">(</mo><mn>0</mn><mo stretchy="false" form="postfix">)</mo><mo>=</mo><msub><mi>E</mi><mrow><mi>B</mi><mi>T</mi><mi>M</mi><mi>S</mi></mrow></msub><mo stretchy="false" form="prefix">(</mo><mn>2</mn><mo stretchy="false" form="postfix">)</mo></mrow><annotation encoding="application/x-tex">E_{BTMS}(0) = E_{BTMS}(2)</annotation></semantics></math>), we get <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable><mtr><mtd columnalign="right"><msub><mi>E</mi><mrow><mi>B</mi><mi>T</mi><mi>M</mi><mi>S</mi></mrow></msub><mo stretchy="false" form="prefix">(</mo><mn>1</mn><mo stretchy="false" form="postfix">)</mo></mtd><mtd columnalign="left"><mo>=</mo><mi>E</mi><mo stretchy="false" form="prefix">(</mo><mn>0</mn><mo stretchy="false" form="postfix">)</mo><mo>+</mo><mi>d</mi><mi>t</mi><mo>⋅</mo><mi>η</mi><mo>⋅</mo><msub><mi>P</mi><mrow><mi>B</mi><mi>T</mi><mi>M</mi><mi>S</mi></mrow></msub><mo stretchy="false" form="prefix">(</mo><mn>0</mn><mo stretchy="false" form="postfix">)</mo></mtd></mtr><mtr><mtd columnalign="right"><msub><mi>E</mi><mrow><mi>B</mi><mi>T</mi><mi>M</mi><mi>S</mi></mrow></msub><mo stretchy="false" form="prefix">(</mo><mn>2</mn><mo stretchy="false" form="postfix">)</mo></mtd><mtd columnalign="left"><mo>=</mo><mi>E</mi><mo stretchy="false" form="prefix">(</mo><mn>1</mn><mo stretchy="false" form="postfix">)</mo><mo>+</mo><mi>d</mi><mi>t</mi><mo>⋅</mo><mi>η</mi><mo>⋅</mo><msub><mi>P</mi><mrow><mi>B</mi><mi>T</mi><mi>M</mi><mi>S</mi></mrow></msub><mo stretchy="false" form="prefix">(</mo><mn>1</mn><mo stretchy="false" form="postfix">)</mo><mspace width="1.0em"></mspace><mo stretchy="false" form="prefix">|</mo><msub><mi>E</mi><mrow><mi>B</mi><mi>T</mi><mi>M</mi><mi>S</mi></mrow></msub><mo stretchy="false" form="prefix">(</mo><mn>0</mn><mo stretchy="false" form="postfix">)</mo><mo>=</mo><msub><mi>E</mi><mrow><mi>B</mi><mi>T</mi><mi>M</mi><mi>S</mi></mrow></msub><mo stretchy="false" form="prefix">(</mo><mn>2</mn><mo stretchy="false" form="postfix">)</mo></mtd></mtr><mtr><mtd columnalign="right"><msub><mi>P</mi><mrow><mi>B</mi><mi>T</mi><mi>M</mi><mi>S</mi></mrow></msub><mo stretchy="false" form="prefix">(</mo><mn>1</mn><mo stretchy="false" form="postfix">)</mo></mtd><mtd columnalign="left"><mo>=</mo><mo>−</mo><msub><mi>P</mi><mrow><mi>B</mi><mi>T</mi><mi>M</mi><mi>S</mi></mrow></msub><mo stretchy="false" form="prefix">(</mo><mn>0</mn><mo stretchy="false" form="postfix">)</mo></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{align} E_{BTMS}(1) &amp;= E(0) + dt \cdot \eta \cdot P_{BTMS}(0)\\ E_{BTMS}(2) &amp;= E(1) + dt \cdot \eta \cdot P_{BTMS}(1) \quad | E_{BTMS}(0) = E_{BTMS}(2)\\ P_{BTMS}(1) &amp;= - P_{BTMS}(0) \end{align}</annotation></semantics></math> Where the in- and outflowing powers within one timestep are the same, which means no physical energy loss occured. This is because the effect of <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>η</mi><annotation encoding="application/x-tex">\eta</annotation></semantics></math> cancels out with the choosen formulation.</p>
<p>Rewriting the energy equation with constraints as <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable><mtr><mtd columnalign="right"><msub><mi>E</mi><mrow><mi>B</mi><mi>T</mi><mi>M</mi><mi>S</mi></mrow></msub><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo>+</mo><mn>1</mn><mo stretchy="false" form="postfix">)</mo></mtd><mtd columnalign="left"><mo>=</mo><msub><mi>E</mi><mrow><mi>B</mi><mi>T</mi><mi>M</mi><mi>S</mi></mrow></msub><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo><mo>+</mo><mi>d</mi><mi>t</mi><mo>⋅</mo><mo stretchy="false" form="prefix">(</mo><mi>η</mi><mo>⋅</mo><msub><mi>P</mi><mrow><mi>B</mi><mi>T</mi><mi>M</mi><mi>S</mi><mo>,</mo><mi>C</mi><mi>h</mi></mrow></msub><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo><mo>+</mo><mfrac><mn>1</mn><mi>η</mi></mfrac><msub><mi>P</mi><mrow><mi>B</mi><mi>T</mi><mi>M</mi><mi>S</mi><mo>,</mo><mi>D</mi><mi>C</mi><mi>h</mi></mrow></msub><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo><mo stretchy="false" form="postfix">)</mo></mtd></mtr><mtr><mtd columnalign="right"><msub><mi>P</mi><mrow><mi>B</mi><mi>T</mi><mi>M</mi><mi>S</mi><mo>,</mo><mi>C</mi><mi>h</mi></mrow></msub><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo></mtd><mtd columnalign="left"><mo>≥</mo><mn>0</mn></mtd></mtr><mtr><mtd columnalign="right"><msub><mi>P</mi><mrow><mi>B</mi><mi>T</mi><mi>M</mi><mi>S</mi><mo>,</mo><mi>D</mi><mi>C</mi><mi>h</mi></mrow></msub><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo></mtd><mtd columnalign="left"><mo>≤</mo><mn>0</mn></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{align} E_{BTMS}(k+1) &amp;= E_{BTMS}(k) + dt \cdot (\eta \cdot P_{BTMS,Ch}(k) + \frac{1}{\eta}P_{BTMS,DCh}(k))\\ P_{BTMS,Ch}(k) &amp;\geq 0 \\ P_{BTMS,DCh}(k) &amp;\leq 0 \\ \end{align}</annotation></semantics></math></p>
<p>delivers for the same cycle <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>P</mi><mrow><mi>B</mi><mi>T</mi><mi>M</mi><mi>S</mi><mo>,</mo><mi>D</mi><mi>C</mi><mi>h</mi></mrow></msub><mo stretchy="false" form="prefix">(</mo><mn>1</mn><mo stretchy="false" form="postfix">)</mo><mo>=</mo><mo>−</mo><msup><mi>η</mi><mn>2</mn></msup><msub><mi>P</mi><mrow><mi>B</mi><mi>T</mi><mi>M</mi><mi>S</mi><mo>,</mo><mi>C</mi><mi>h</mi></mrow></msub><mo stretchy="false" form="prefix">(</mo><mn>0</mn><mo stretchy="false" form="postfix">)</mo></mrow><annotation encoding="application/x-tex">\begin{equation} P_{BTMS,DCh}(1) = -\eta^2 P_{BTMS,Ch}(0) \end{equation}</annotation></semantics></math> which represents the energy loss correctly. Likewise, we are also able to implement the cost of the energy loss as (<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>P</mi><mrow><mi>B</mi><mi>T</mi><mi>M</mi><mi>S</mi><mo>,</mo><mi>D</mi><mi>C</mi><mi>h</mi></mrow></msub><mo>≤</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">P_{BTMS,DCh} \leq 0</annotation></semantics></math>) <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>C</mi><mrow><mi>l</mi><mi>o</mi><mi>s</mi><mi>s</mi></mrow></msub><mo>=</mo><msub><mi>c</mi><mrow><mi>e</mi><mi>l</mi></mrow></msub><mo>⋅</mo><mo stretchy="false" form="prefix">(</mo><msubsup><mi>Σ</mi><mrow><mi>k</mi><mo>=</mo><mn>0</mn></mrow><mrow><mi>k</mi><mo>=</mo><mi>T</mi></mrow></msubsup><msub><mi>P</mi><mrow><mi>B</mi><mi>T</mi><mi>M</mi><mi>S</mi><mo>,</mo><mi>C</mi><mi>h</mi></mrow></msub><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo><mi>d</mi><mi>t</mi><mo>+</mo><msubsup><mi>Σ</mi><mrow><mi>k</mi><mo>=</mo><mn>0</mn></mrow><mrow><mi>k</mi><mo>=</mo><mi>T</mi></mrow></msubsup><msub><mi>P</mi><mrow><mi>B</mi><mi>T</mi><mi>M</mi><mi>S</mi><mo>,</mo><mi>D</mi><mi>C</mi><mi>h</mi></mrow></msub><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo><mi>d</mi><mi>t</mi><mo stretchy="false" form="postfix">)</mo></mrow><annotation encoding="application/x-tex">\begin{equation} C_{loss} = c_{el} \cdot (\Sigma_{k=0}^{k=T} P_{BTMS,Ch}(k)dt + \Sigma_{k=0}^{k=T}P_{BTMS,DCh}(k)dt) \end{equation}</annotation></semantics></math> with <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>c</mi><mrow><mi>e</mi><mi>l</mi></mrow></msub><annotation encoding="application/x-tex">c_{el}</annotation></semantics></math> as the electricity cost. This is only valid when assuming <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>E</mi><mrow><mi>B</mi><mi>T</mi><mi>M</mi><mi>S</mi></mrow></msub><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo>=</mo><mn>0</mn><mo stretchy="false" form="postfix">)</mo><mo>=</mo><msub><mi>E</mi><mrow><mi>B</mi><mi>T</mi><mi>M</mi><mi>S</mi></mrow></msub><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo>=</mo><mi>T</mi><mo>+</mo><mn>1</mn><mo stretchy="false" form="postfix">)</mo></mrow><annotation encoding="application/x-tex">E_{BTMS}(k=0) = E_{BTMS}(k=T+1)</annotation></semantics></math>.</p>
<h2 id="level-optimal-day-aheadlong-term-plan">2. Level: Optimal day-ahead/long-term plan</h2>
<p>in <em>planning()</em>:</p>
<p><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable><mtr><mtd columnalign="right"><mo>min</mo><mspace width="1.0em"></mspace><mi>a</mi><mo>⋅</mo><mo stretchy="false" form="prefix">(</mo><msub><mi>P</mi><mrow><mi>s</mi><mi>l</mi><mi>a</mi><mi>c</mi><mi>k</mi></mrow></msub><mo>−</mo><msub><mi>P</mi><mrow><mi>f</mi><mi>r</mi><mi>e</mi><mi>e</mi></mrow></msub><mo stretchy="false" form="postfix">)</mo><mo>+</mo><mi>b</mi><mo>⋅</mo><msubsup><mi>Σ</mi><mrow><mi>k</mi><mo>=</mo><mn>0</mn></mrow><mi>T</mi></msubsup><msub><mi>P</mi><mrow><mi>B</mi><mi>T</mi><mi>M</mi><mi>S</mi><mo>,</mo><mi>C</mi><mi>h</mi></mrow></msub><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo><mi>d</mi><mi>t</mi><mo>+</mo><mi>c</mi><mo>⋅</mo><mo stretchy="false" form="prefix">(</mo><msubsup><mi>Σ</mi><mrow><mi>k</mi><mo>=</mo><mn>0</mn></mrow><mrow><mi>k</mi><mo>=</mo><mi>T</mi></mrow></msubsup><msub><mi>P</mi><mrow><mi>B</mi><mi>T</mi><mi>M</mi><mi>S</mi><mo>,</mo><mi>C</mi><mi>h</mi></mrow></msub><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo><mi>d</mi><mi>t</mi><mo>+</mo><msubsup><mi>Σ</mi><mrow><mi>k</mi><mo>=</mo><mn>0</mn></mrow><mrow><mi>k</mi><mo>=</mo><mi>T</mi></mrow></msubsup><msub><mi>P</mi><mrow><mi>B</mi><mi>T</mi><mi>M</mi><mi>S</mi><mo>,</mo><mi>D</mi><mi>C</mi><mi>h</mi></mrow></msub><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo><mi>d</mi><mi>t</mi><mo stretchy="false" form="postfix">)</mo></mtd></mtr><mtr><mtd columnalign="right"><mspace width="0.222em"></mspace><mo>+</mo><msubsup><mi>Σ</mi><mrow><mi>k</mi><mo>=</mo><mn>0</mn></mrow><mrow><mi>k</mi><mo>=</mo><mi>T</mi><mo>+</mo><mn>1</mn></mrow></msubsup><mi>d</mi><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo><mo>⋅</mo><msub><mi>t</mi><mrow><mi>w</mi><mi>a</mi><mi>i</mi><mi>t</mi></mrow></msub><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{equation} \begin{aligned} \min \quad a \cdot (P_{slack} - P_{free}) + b \cdot \Sigma_{k=0}^{T} P_{BTMS,Ch}(k)dt + c \cdot (\Sigma_{k=0}^{k=T} P_{BTMS,Ch}(k)dt + \Sigma_{k=0}^{k=T}P_{BTMS,DCh}(k)dt) \\\
+\Sigma_{k=0}^{k=T+1} d(k) \cdot t_{wait}(k) \end{aligned} \end{equation}</annotation></semantics></math></p>
<p>subject to: <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable><mtr><mtd columnalign="right"><msub><mi>E</mi><mrow><mi>B</mi><mi>T</mi><mi>M</mi><mi>S</mi></mrow></msub><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo>+</mo><mn>1</mn><mo stretchy="false" form="postfix">)</mo></mtd><mtd columnalign="left"><mo>=</mo><msub><mi>E</mi><mrow><mi>B</mi><mi>T</mi><mi>M</mi><mi>S</mi></mrow></msub><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo><mo>+</mo><mi>d</mi><mi>t</mi><mo>⋅</mo><mo stretchy="false" form="prefix">(</mo><mi>η</mi><mo>⋅</mo><msub><mi>P</mi><mrow><mi>B</mi><mi>T</mi><mi>M</mi><mi>S</mi><mo>,</mo><mi>C</mi><mi>h</mi></mrow></msub><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo><mo>+</mo><mfrac><mn>1</mn><mi>η</mi></mfrac><msub><mi>P</mi><mrow><mi>B</mi><mi>T</mi><mi>M</mi><mi>S</mi><mo>,</mo><mi>D</mi><mi>C</mi><mi>h</mi></mrow></msub><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo><mo stretchy="false" form="postfix">)</mo><mspace width="1.0em"></mspace></mtd><mtd columnalign="right"><mo>∀</mo><mi>k</mi><mo>∈</mo><mo stretchy="false" form="prefix">[</mo><mn>0</mn><mo>,</mo><mi>T</mi><mo stretchy="false" form="postfix">]</mo></mtd></mtr><mtr><mtd columnalign="right"><msub><mi>E</mi><mrow><mi>S</mi><mi>h</mi><mi>i</mi><mi>f</mi><mi>t</mi></mrow></msub><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo>+</mo><mn>1</mn><mo stretchy="false" form="postfix">)</mo></mtd><mtd columnalign="left"><mo>=</mo><msub><mi>E</mi><mrow><mi>S</mi><mi>h</mi><mi>i</mi><mi>f</mi><mi>t</mi></mrow></msub><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo><mo>+</mo><mi>d</mi><mi>t</mi><mo>⋅</mo><msub><mi>P</mi><mrow><mi>S</mi><mi>h</mi><mi>i</mi><mi>f</mi><mi>t</mi></mrow></msub><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo></mtd></mtr><mtr><mtd columnalign="right"><msub><mi>P</mi><mrow><mi>C</mi><mi>h</mi><mi>a</mi><mi>r</mi><mi>g</mi><mi>e</mi></mrow></msub><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo><mo>−</mo><msub><mi>P</mi><mrow><mi>S</mi><mi>h</mi><mi>i</mi><mi>f</mi><mi>t</mi></mrow></msub><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo></mtd><mtd columnalign="left"><mo>=</mo><msub><mi>P</mi><mrow><mi>G</mi><mi>r</mi><mi>i</mi><mi>d</mi></mrow></msub><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo><mo>−</mo><msub><mi>P</mi><mrow><mi>B</mi><mi>T</mi><mi>M</mi><mi>S</mi></mrow></msub><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo><mspace width="1.0em"></mspace></mtd><mtd columnalign="right"><mo>∀</mo><mi>k</mi><mo>∈</mo><mo stretchy="false" form="prefix">[</mo><mn>0</mn><mo>,</mo><mi>T</mi><mo stretchy="false" form="postfix">]</mo></mtd></mtr><mtr><mtd columnalign="right"><msub><mi>P</mi><mrow><mi>B</mi><mi>T</mi><mi>M</mi><mi>S</mi></mrow></msub><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo></mtd><mtd columnalign="left"><mo>=</mo><msub><mi>P</mi><mrow><mi>B</mi><mi>T</mi><mi>M</mi><mi>S</mi><mo>,</mo><mi>C</mi><mi>h</mi></mrow></msub><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo><mo>+</mo><msub><mi>P</mi><mrow><mi>B</mi><mi>T</mi><mi>M</mi><mi>S</mi><mo>,</mo><mi>D</mi><mi>C</mi><mi>h</mi></mrow></msub><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo><mspace width="1.0em"></mspace></mtd><mtd columnalign="right"><mo>∀</mo><mi>k</mi><mo>∈</mo><mo stretchy="false" form="prefix">[</mo><mn>0</mn><mo>,</mo><mi>T</mi><mo stretchy="false" form="postfix">]</mo></mtd></mtr><mtr><mtd columnalign="right"><msub><mi>P</mi><mrow><mi>B</mi><mi>T</mi><mi>M</mi><mi>S</mi><mo>,</mo><mi>C</mi><mi>h</mi></mrow></msub><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo></mtd><mtd columnalign="left"><mo>≥</mo><mn>0</mn><mspace width="1.0em"></mspace></mtd><mtd columnalign="right"><mo>∀</mo><mi>k</mi><mo>∈</mo><mo stretchy="false" form="prefix">[</mo><mn>0</mn><mo>,</mo><mi>T</mi><mo stretchy="false" form="postfix">]</mo></mtd></mtr><mtr><mtd columnalign="right"><msub><mi>P</mi><mrow><mi>B</mi><mi>T</mi><mi>M</mi><mi>S</mi><mo>,</mo><mi>D</mi><mi>C</mi><mi>h</mi></mrow></msub><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo></mtd><mtd columnalign="left"><mo>≤</mo><mn>0</mn><mspace width="1.0em"></mspace></mtd><mtd columnalign="right"><mo>∀</mo><mi>k</mi><mo>∈</mo><mo stretchy="false" form="prefix">[</mo><mn>0</mn><mo>,</mo><mi>T</mi><mo stretchy="false" form="postfix">]</mo></mtd></mtr><mtr><mtd columnalign="right"><msub><mi>t</mi><mrow><mi>w</mi><mi>a</mi><mi>i</mi><mi>t</mi></mrow></msub><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo></mtd><mtd columnalign="left"><mo>≥</mo><mi>d</mi><mi>t</mi><mo>⋅</mo><mo stretchy="false" form="prefix">(</mo><msub><mi>n</mi><mi>a</mi></msub><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo><mo>+</mo><msub><mi>n</mi><mi>b</mi></msub><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo><mo stretchy="false" form="postfix">)</mo></mtd><mtd columnalign="right"><mo>∀</mo><mi>k</mi><mo>∈</mo><mo stretchy="false" form="prefix">[</mo><mn>0</mn><mo>,</mo><mi>T</mi><mo stretchy="false" form="postfix">]</mo></mtd></mtr><mtr><mtd columnalign="right"><msub><mi>n</mi><mi>a</mi></msub><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo></mtd><mtd columnalign="left"><mo>≥</mo><mfrac><mrow><msub><mi>E</mi><mrow><mi>S</mi><mi>h</mi><mi>i</mi><mi>f</mi><mi>t</mi></mrow></msub><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo></mrow><mrow><msub><mi>P</mi><mrow><mi>c</mi><mi>h</mi><mo>,</mo><mi>a</mi><mi>v</mi><mi>g</mi></mrow></msub><mo>⋅</mo><mi>d</mi><mi>t</mi></mrow></mfrac></mtd><mtd columnalign="right"><mo>∀</mo><mi>k</mi><mo>∈</mo><mo stretchy="false" form="prefix">[</mo><mn>0</mn><mo>,</mo><mi>T</mi><mo stretchy="false" form="postfix">]</mo></mtd></mtr><mtr><mtd columnalign="right"><msub><mi>n</mi><mi>b</mi></msub><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo></mtd><mtd columnalign="left"><mo>≥</mo><mfrac><mrow><msub><mi>P</mi><mrow><mi>S</mi><mi>h</mi><mi>i</mi><mi>f</mi><mi>t</mi></mrow></msub><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo></mrow><msub><mi>P</mi><mrow><mi>c</mi><mi>h</mi><mo>,</mo><mi>a</mi><mi>v</mi><mi>g</mi></mrow></msub></mfrac></mtd><mtd columnalign="right"><mo>∀</mo><mi>k</mi><mo>∈</mo><mo stretchy="false" form="prefix">[</mo><mn>0</mn><mo>,</mo><mi>T</mi><mo stretchy="false" form="postfix">]</mo></mtd></mtr><mtr><mtd columnalign="right"><msub><mi>n</mi><mi>b</mi></msub><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo></mtd><mtd columnalign="left"><mo>≥</mo><mn>0</mn></mtd><mtd columnalign="right"><mo>∀</mo><mi>k</mi><mo>∈</mo><mo stretchy="false" form="prefix">[</mo><mn>0</mn><mo>,</mo><mi>T</mi><mo stretchy="false" form="postfix">]</mo></mtd></mtr><mtr><mtd columnalign="right"><msub><mi>E</mi><mrow><mi>B</mi><mi>T</mi><mi>M</mi><mi>S</mi></mrow></msub><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo></mtd><mtd columnalign="left"><mo>≥</mo><mn>0</mn><mspace width="1.0em"></mspace></mtd><mtd columnalign="right"><mo>∀</mo><mi>k</mi><mo>∈</mo><mo stretchy="false" form="prefix">[</mo><mn>0</mn><mo>,</mo><mi>T</mi><mo>+</mo><mn>1</mn><mo stretchy="false" form="postfix">]</mo></mtd></mtr><mtr><mtd columnalign="right"><msub><mi>E</mi><mrow><mi>B</mi><mi>T</mi><mi>M</mi><mi>S</mi></mrow></msub><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo></mtd><mtd columnalign="left"><mo>≤</mo><mi>Δ</mi><msub><mi>E</mi><mrow><mi>B</mi><mi>T</mi><mi>M</mi><mi>S</mi></mrow></msub><mspace width="1.0em"></mspace></mtd><mtd columnalign="right"><mo>∀</mo><mi>k</mi><mo>∈</mo><mo stretchy="false" form="prefix">[</mo><mn>0</mn><mo>,</mo><mi>T</mi><mo>+</mo><mn>1</mn><mo stretchy="false" form="postfix">]</mo></mtd></mtr><mtr><mtd columnalign="right"><msub><mi>E</mi><mrow><mi>S</mi><mi>h</mi><mi>i</mi><mi>f</mi><mi>t</mi></mrow></msub><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo></mtd><mtd columnalign="left"><mo>≥</mo><mn>0</mn><mspace width="1.0em"></mspace></mtd><mtd columnalign="right"><mo>∀</mo><mi>k</mi><mo>∈</mo><mo stretchy="false" form="prefix">[</mo><mn>0</mn><mo>,</mo><mi>T</mi><mo>+</mo><mn>1</mn><mo stretchy="false" form="postfix">]</mo></mtd></mtr><mtr><mtd columnalign="right"><msub><mi>E</mi><mrow><mi>B</mi><mi>T</mi><mi>M</mi><mi>S</mi></mrow></msub><mo stretchy="false" form="prefix">(</mo><mn>0</mn><mo stretchy="false" form="postfix">)</mo></mtd><mtd columnalign="left"><mo>=</mo><msub><mi>E</mi><mrow><mi>B</mi><mi>T</mi><mi>M</mi><mi>S</mi></mrow></msub><mo stretchy="false" form="prefix">(</mo><mi>T</mi><mo>+</mo><mn>1</mn><mo stretchy="false" form="postfix">)</mo></mtd></mtr><mtr><mtd columnalign="right"><msub><mi>E</mi><mrow><mi>S</mi><mi>h</mi><mi>i</mi><mi>f</mi><mi>t</mi></mrow></msub><mo stretchy="false" form="prefix">(</mo><mn>0</mn><mo stretchy="false" form="postfix">)</mo></mtd><mtd columnalign="left"><mo>=</mo><mn>0</mn></mtd></mtr><mtr><mtd columnalign="right"><msub><mi>P</mi><mrow><mi>s</mi><mi>l</mi><mi>a</mi><mi>c</mi><mi>k</mi></mrow></msub></mtd><mtd columnalign="left"><mo>≥</mo><mo>max</mo><mo stretchy="false" form="prefix">(</mo><msub><mi>P</mi><mrow><mi>G</mi><mi>r</mi><mi>i</mi><mi>d</mi></mrow></msub><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo><mo stretchy="false" form="postfix">)</mo></mtd></mtr><mtr><mtd columnalign="right"><msub><mi>P</mi><mrow><mi>s</mi><mi>l</mi><mi>a</mi><mi>c</mi><mi>k</mi></mrow></msub></mtd><mtd columnalign="left"><mo>≥</mo><msub><mi>P</mi><mrow><mi>f</mi><mi>r</mi><mi>e</mi><mi>e</mi></mrow></msub></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{align} E_{BTMS}(k+1) &amp;= E_{BTMS}(k) + dt \cdot (\eta \cdot P_{BTMS,Ch}(k) + \frac{1}{\eta}P_{BTMS,DCh}(k)) \quad &amp;\forall k \in [0,T]\\ E_{Shift}(k+1) &amp;= E_{Shift}(k) + dt \cdot P_{Shift}(k) \\ P_{Charge}(k) - P_{Shift}(k) &amp;= P_{Grid}(k) - P_{BTMS}(k) \quad &amp;\forall k \in [0,T] \\ P_{BTMS}(k) &amp;= P_{BTMS,Ch}(k) + P_{BTMS,DCh}(k) \quad &amp;\forall k \in [0,T]\\ P_{BTMS,Ch}(k) &amp;\geq 0 \quad &amp;\forall k \in [0,T]\\ P_{BTMS,DCh}(k) &amp;\leq 0 \quad &amp;\forall k \in [0,T]\\ t_{wait}(k) &amp;\geq dt \cdot (n_a(k) +n_b(k)) &amp;\forall k \in [0,T] \\ n_a(k) &amp;\geq \frac{E_{Shift}(k)}{P_{ch,avg} \cdot dt} &amp;\forall k \in [0,T] \\ n_b(k) &amp;\geq \frac{P_{Shift}(k)}{P_{ch,avg}} &amp;\forall k \in [0,T] \\ n_b(k) &amp;\geq 0 &amp;\forall k \in [0,T]\\ E_{BTMS}(k) &amp;\geq 0 \quad &amp;\forall k \in [0,T+1]\\ E_{BTMS}(k) &amp;\leq \Delta E_{BTMS} \quad &amp;\forall k \in [0,T+1] \\ E_{Shift}(k) &amp;\geq 0 \quad &amp;\forall k \in [0,T+1]\\ E_{BTMS}(0) &amp;= E_{BTMS}(T+1)\\ E_{Shift}(0) &amp;= 0\\ P_{slack} &amp;\geq \max(P_{Grid}(k))\\ P_{slack} &amp;\geq P_{free}\\ \end{align}</annotation></semantics></math> We added the BTMS size <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Δ</mi><msub><mi>E</mi><mrow><mi>B</mi><mi>T</mi><mi>M</mi><mi>S</mi></mrow></msub></mrow><annotation encoding="application/x-tex">\Delta E_{BTMS}</annotation></semantics></math> to the constraint, and ensured that the energy level is between this and 0. Furthermore, we set <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>E</mi><mrow><mi>B</mi><mi>T</mi><mi>M</mi><mi>S</mi></mrow></msub><mo stretchy="false" form="prefix">(</mo><mn>0</mn><mo stretchy="false" form="postfix">)</mo><mo>=</mo><msub><mi>E</mi><mrow><mi>B</mi><mi>T</mi><mi>M</mi><mi>S</mi></mrow></msub><mo stretchy="false" form="prefix">(</mo><mi>T</mi><mo>+</mo><mn>1</mn><mo stretchy="false" form="postfix">)</mo></mrow><annotation encoding="application/x-tex">E_{BTMS}(0) = E_{BTMS}(T+1)</annotation></semantics></math> to ensure that the BTMS isn’t completly discharged in our case of a one day simulation. For real-world usage, optimization for 2 or 3 days in advance might be better solution, with just using the results for the first day.</p>
<p>Compared to the approach described in 1st level for determining BTMS-size, we added the ability to shift charging power, i.e. to decrease charging speed of vehicles. For this, we increase the state of shifted energy <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>E</mi><mrow><mi>S</mi><mi>h</mi><mi>i</mi><mi>f</mi><mi>t</mi></mrow></msub><annotation encoding="application/x-tex">E_{Shift}</annotation></semantics></math> which serves as a stock for the shifted power [?and has an equal defintion of the earlier introduced energy lag]. We then derive from the shifted energy the generated waiting time <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>t</mi><mrow><mi>w</mi><mi>a</mi><mi>i</mi><mi>t</mi></mrow></msub><annotation encoding="application/x-tex">t_{wait}</annotation></semantics></math>, which can be penalized with the tuning parameter <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>d</mi><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo></mrow><annotation encoding="application/x-tex">d(k)</annotation></semantics></math>. This parameter <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>d</mi><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo></mrow><annotation encoding="application/x-tex">d(k)</annotation></semantics></math> is defined for every timestep, so that e.g. higher waiting time cost at ride-hailing peak-demand times could be implemented, to further prioritize having enough available charging power at these times. Please look down in the document to understand, how we dervie the waiting time.</p>
<p>We define our state, control, disturbance and slack variables as: <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable><mtr><mtd columnalign="right"><mi>x</mi><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo></mtd><mtd columnalign="left"><mo>=</mo><mo stretchy="false" form="prefix">[</mo><msub><mi>E</mi><mrow><mi>B</mi><mi>T</mi><mi>M</mi><mi>S</mi></mrow></msub><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo><mo>,</mo><msub><mi>E</mi><mrow><mi>S</mi><mi>h</mi><mi>i</mi><mi>f</mi><mi>t</mi></mrow></msub><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo><mo stretchy="false" form="postfix">]</mo></mtd></mtr><mtr><mtd columnalign="right"><mi>u</mi><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo></mtd><mtd columnalign="left"><mo>=</mo><mo stretchy="false" form="prefix">[</mo><msub><mi>P</mi><mrow><mi>G</mi><mi>r</mi><mi>i</mi><mi>d</mi></mrow></msub><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo><mo>,</mo><msub><mi>P</mi><mrow><mi>B</mi><mi>T</mi><mi>M</mi><mi>S</mi></mrow></msub><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo><mo>,</mo><msub><mi>P</mi><mrow><mi>B</mi><mi>T</mi><mi>M</mi><mi>S</mi><mo>,</mo><mi>C</mi><mi>h</mi></mrow></msub><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo><mo>,</mo><msub><mi>P</mi><mrow><mi>B</mi><mi>T</mi><mi>M</mi><mi>S</mi><mo>,</mo><mi>D</mi><mi>C</mi><mi>h</mi></mrow></msub><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo><mo>,</mo><msub><mi>P</mi><mrow><mi>S</mi><mi>h</mi><mi>i</mi><mi>f</mi><mi>t</mi></mrow></msub><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo><mo stretchy="false" form="postfix">]</mo></mtd></mtr><mtr><mtd columnalign="right"><mi>i</mi><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo></mtd><mtd columnalign="left"><mo>=</mo><mo stretchy="false" form="prefix">[</mo><msub><mi>P</mi><mrow><mi>C</mi><mi>h</mi><mi>a</mi><mi>r</mi><mi>g</mi><mi>e</mi></mrow></msub><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo><mo stretchy="false" form="postfix">]</mo></mtd></mtr><mtr><mtd columnalign="right"><msub><mi>P</mi><mrow><mi>s</mi><mi>l</mi><mi>a</mi><mi>c</mi><mi>k</mi></mrow></msub><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo><mo>,</mo></mtd><mtd columnalign="left"><msub><mi>t</mi><mrow><mi>w</mi><mi>a</mi><mi>i</mi><mi>t</mi></mrow></msub><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo><mo>,</mo><mi>n</mi><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo><mo>=</mo><mo stretchy="false" form="prefix">[</mo><msub><mi>n</mi><mi>a</mi></msub><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo><mo>,</mo><msub><mi>n</mi><mi>b</mi></msub><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo><mo stretchy="false" form="postfix">]</mo></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{align} x(k) &amp;= [E_{BTMS}(k), E_{Shift}(k)]\\ u(k) &amp;= [P_{Grid}(k), P_{BTMS}(k), P_{BTMS,Ch}(k), P_{BTMS,DCh}(k), P_{Shift}(k)] \\ i(k) &amp;= [P_{Charge}(k)]\\ P_{slack}(k), &amp; t_{wait}(k), n(k) = [n_a(k), n_b(k)] \end{align}</annotation></semantics></math></p>
<p>From this, we can obtain a trajectory for the desired Energy Level in the behind the meter storage. From this, we determine a load band with <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>β</mi><annotation encoding="application/x-tex">\beta</annotation></semantics></math> upper and lower deviations of the BTMS-size <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Δ</mi><msub><mi>E</mi><mrow><mi>B</mi><mi>T</mi><mi>M</mi><mi>S</mi></mrow></msub></mrow><annotation encoding="application/x-tex">\Delta E_{BTMS}</annotation></semantics></math>. We apply the min- and max-function to ensure, that we don’t exceed storage size with this.</p>
<p><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable><mtr><mtd columnalign="right"><msub><mi>E</mi><mrow><mi>B</mi><mi>T</mi><mi>M</mi><mi>S</mi><mo>,</mo><mi>l</mi><mi>o</mi><mi>w</mi><mi>e</mi><mi>r</mi></mrow></msub><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo></mtd><mtd columnalign="left"><mo>=</mo><mo>max</mo><mo stretchy="false" form="prefix">(</mo><mo stretchy="false" form="prefix">[</mo><mn>0</mn><mtext mathvariant="normal">kWh</mtext><mo>,</mo><msub><mi>E</mi><mrow><mi>B</mi><mi>T</mi><mi>M</mi><mi>S</mi></mrow></msub><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo><mo>−</mo><mi>β</mi><mi>Δ</mi><msub><mi>E</mi><mrow><mi>B</mi><mi>T</mi><mi>M</mi><mi>S</mi></mrow></msub><mo stretchy="false" form="postfix">]</mo><mo stretchy="false" form="postfix">)</mo></mtd></mtr><mtr><mtd columnalign="right"><msub><mi>E</mi><mrow><mi>B</mi><mi>T</mi><mi>M</mi><mi>S</mi><mo>,</mo><mi>u</mi><mi>p</mi><mi>p</mi><mi>e</mi><mi>r</mi></mrow></msub><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo></mtd><mtd columnalign="left"><mo>=</mo><mo>min</mo><mo stretchy="false" form="prefix">(</mo><mo stretchy="false" form="prefix">[</mo><mi>Δ</mi><msub><mi>E</mi><mrow><mi>B</mi><mi>T</mi><mi>M</mi><mi>S</mi></mrow></msub><mo>,</mo><msub><mi>E</mi><mrow><mi>B</mi><mi>T</mi><mi>M</mi><mi>S</mi></mrow></msub><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo><mo>+</mo><mi>β</mi><mi>Δ</mi><msub><mi>E</mi><mrow><mi>B</mi><mi>T</mi><mi>M</mi><mi>S</mi></mrow></msub><mo stretchy="false" form="postfix">]</mo><mo stretchy="false" form="postfix">)</mo></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{align} E_{BTMS,lower}(k) &amp;= \max([0\text{kWh}, E_{BTMS}(k)-\beta\Delta E_{BTMS}])\\ E_{BTMS,upper}(k) &amp;= \min([\Delta E_{BTMS}, E_{BTMS}(k)+\beta\Delta E_{BTMS}]) \end{align}</annotation></semantics></math></p>
<p><strong>remark 1</strong>: We might have to add a constraint to ensure that the shifted energy does match 0 at the end (e.g. <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>E</mi><mrow><mi>S</mi><mi>h</mi><mi>i</mi><mi>f</mi><mi>t</mi></mrow></msub><mo stretchy="false" form="prefix">(</mo><mi>T</mi><mo stretchy="false" form="postfix">)</mo><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">E_{Shift}(T) = 0</annotation></semantics></math>), but ideally, the cost function should do this .</p>
<p><strong>remark 2</strong>: In order to correctly weigh the parameters of the cost-function to each other, we assume that we optimize over one day. For that, we divide the demand charge in such a way, that it is projected to one day. e.g. if it is given for one month, we divide it by 30 days.</p>
<p><strong>remark 3</strong>: The code also allows to add a C-Rating, which adds the constraint <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable><mtr><mtd columnalign="right"><msub><mi>P</mi><mrow><mi>B</mi><mi>T</mi><mi>M</mi><mi>S</mi><mo>,</mo><mi>C</mi><mi>h</mi></mrow></msub><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo></mtd><mtd columnalign="left"><mo>≤</mo><mi>C</mi><mo>⋅</mo><mi>Δ</mi><msub><mi>E</mi><mrow><mi>B</mi><mi>T</mi><mi>M</mi><mi>S</mi></mrow></msub><mspace width="1.0em"></mspace></mtd><mtd columnalign="right"><mo>∀</mo><mi>k</mi><mo>∈</mo><mo stretchy="false" form="prefix">[</mo><mn>0</mn><mo>,</mo><mi>T</mi><mo stretchy="false" form="postfix">]</mo></mtd></mtr><mtr><mtd columnalign="right"><msub><mi>P</mi><mrow><mi>B</mi><mi>T</mi><mi>M</mi><mi>S</mi><mo>,</mo><mi>D</mi><mi>C</mi><mi>h</mi></mrow></msub><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo></mtd><mtd columnalign="left"><mo>≥</mo><mi>C</mi><mo>⋅</mo><mi>Δ</mi><msub><mi>E</mi><mrow><mi>B</mi><mi>T</mi><mi>M</mi><mi>S</mi></mrow></msub><mspace width="1.0em"></mspace></mtd><mtd columnalign="right"><mo>∀</mo><mi>k</mi><mo>∈</mo><mo stretchy="false" form="prefix">[</mo><mn>0</mn><mo>,</mo><mi>T</mi><mo stretchy="false" form="postfix">]</mo></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{align} P_{BTMS,Ch}(k) &amp;\leq C \cdot \Delta E_{BTMS} \quad &amp;\forall k \in [0,T]\\ P_{BTMS,DCh}(k) &amp;\geq C \cdot \Delta E_{BTMS} \quad &amp;\forall k \in [0,T]\\ \end{align}</annotation></semantics></math></p>
<p><strong>Option</strong>: We could also include predictions for power grid constraints like <math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>P</mi><mrow><mi>G</mi><mi>r</mi><mi>i</mi><mi>d</mi></mrow></msub><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo><mo>≤</mo><msub><mi>P</mi><mrow><mi>G</mi><mi>r</mi><mi>i</mi><mi>d</mi><mo>,</mo><mi>L</mi><mi>i</mi><mi>m</mi><mi>i</mi><mi>t</mi><mo>,</mo><mi>p</mi><mi>r</mi><mi>e</mi><mi>d</mi></mrow></msub><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo><mspace width="1.0em"></mspace><mo>∀</mo><mi>k</mi><mo>∈</mo><mo stretchy="false" form="prefix">[</mo><mn>0</mn><mo>,</mo><mi>T</mi><mo stretchy="false" form="postfix">]</mo></mrow><annotation encoding="application/x-tex">\begin{equation*}
P_{Grid}(k) \leq P_{Grid,Limit,pred}(k) \quad \forall k \in [0,T]
\end{equation*}</annotation></semantics></math></p>
<h3 id="explanation-of-waiting-time">explanation of waiting time</h3>
<p>The waiting at the charging station is the result of 2 values:</p>
<ul>
<li><ol type="a">
<li>waiting time due to already shifted energy at time <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>k</mi><annotation encoding="application/x-tex">k</annotation></semantics></math></li>
</ol></li>
<li><ol start="2" type="a">
<li>waiting time due to shifted energy at time <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>k</mi><annotation encoding="application/x-tex">k</annotation></semantics></math></li>
</ol></li>
</ul>
<p><img src="informations/04_18_22 MPC types.png" alt="explanation of waiting time" style="height: 400px;"/></p>
<p>For a), the number of vehicles which is resembled by the already shifted energy <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>E</mi><mrow><mi>S</mi><mi>h</mi><mi>i</mi><mi>f</mi><mi>t</mi></mrow></msub><annotation encoding="application/x-tex">E_{Shift}</annotation></semantics></math> can be calculated as: <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>n</mi><mi>a</mi></msub><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo><mo>=</mo><mfrac><mrow><msub><mi>E</mi><mrow><mi>S</mi><mi>h</mi><mi>i</mi><mi>f</mi><mi>t</mi></mrow></msub><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo></mrow><mrow><msub><mi>P</mi><mrow><mi>c</mi><mi>h</mi><mo>,</mo><mi>a</mi><mi>v</mi><mi>g</mi></mrow></msub><mo>⋅</mo><mi>d</mi><mi>t</mi></mrow></mfrac></mrow><annotation encoding="application/x-tex">\begin{equation} n_a(k) = \frac{E_{Shift}(k)}{P_{ch,avg} \cdot dt} \end{equation}</annotation></semantics></math></p>
<p>For b), the number of vehicles which is resembled by the newly shifted energy <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>P</mi><mrow><mi>S</mi><mi>h</mi><mi>i</mi><mi>f</mi><mi>t</mi></mrow></msub><mo>⋅</mo><mi>d</mi><mi>t</mi></mrow><annotation encoding="application/x-tex">P_{Shift}\cdot dt</annotation></semantics></math> can be calculated as <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>n</mi><mi>b</mi></msub><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo><mo>=</mo><mfrac><mrow><msub><mi>P</mi><mrow><mi>S</mi><mi>h</mi><mi>i</mi><mi>f</mi><mi>t</mi></mrow></msub><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo><mo>⋅</mo><mi>d</mi><mi>t</mi></mrow><mrow><msub><mi>P</mi><mrow><mi>c</mi><mi>h</mi><mo>,</mo><mi>a</mi><mi>v</mi><mi>g</mi></mrow></msub><mo>⋅</mo><mi>d</mi><mi>t</mi></mrow></mfrac></mrow><annotation encoding="application/x-tex">\begin{equation} n_b(k) = \frac{P_{Shift}(k)\cdot dt}{P_{ch,avg}\cdot dt} \end{equation}</annotation></semantics></math> which is valid for the case <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>P</mi><mrow><mi>S</mi><mi>h</mi><mi>i</mi><mi>f</mi><mi>t</mi></mrow></msub><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo><mo>≥</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">P_{Shift}(k)\geq0</annotation></semantics></math>. If <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>P</mi><mrow><mi>S</mi><mi>h</mi><mi>i</mi><mi>f</mi><mi>t</mi></mrow></msub><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo><mo>&lt;</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">P_{Shift}(k)&lt;0</annotation></semantics></math>, the vehicles are released at the end of the timestep, so that they are within the timestep still at the charging station, which means we have to add a constraint that <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>n</mi><mi>b</mi></msub><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo><mo>≥</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">n_b(k) \geq 0</annotation></semantics></math>.</p>
<p>The total waiting time increase during one time step is then the number of waiting vehicles multiplied by the duration of one timestep <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>t</mi><mrow><mi>w</mi><mi>a</mi><mi>i</mi><mi>t</mi></mrow></msub><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo><mo>=</mo><mi>d</mi><mi>t</mi><mo>⋅</mo><mo stretchy="false" form="prefix">(</mo><msub><mi>n</mi><mi>a</mi></msub><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo><mo>+</mo><msub><mi>n</mi><mi>b</mi></msub><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo><mo stretchy="false" form="postfix">)</mo></mrow><annotation encoding="application/x-tex">\begin{equation} t_{wait}(k) = dt \cdot (n_a(k) +n_b(k)) \end{equation}</annotation></semantics></math></p>
<p>To express this as constraints of the minimization problem, we write</p>
<p><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable><mtr><mtd columnalign="right"><msub><mi>t</mi><mrow><mi>w</mi><mi>a</mi><mi>i</mi><mi>t</mi></mrow></msub><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo></mtd><mtd columnalign="left"><mo>≥</mo><mi>d</mi><mi>t</mi><mo>⋅</mo><mo stretchy="false" form="prefix">(</mo><msub><mi>n</mi><mi>a</mi></msub><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo><mo>+</mo><msub><mi>n</mi><mi>b</mi></msub><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo><mo stretchy="false" form="postfix">)</mo></mtd></mtr><mtr><mtd columnalign="right"><msub><mi>n</mi><mi>a</mi></msub><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo></mtd><mtd columnalign="left"><mo>≥</mo><mfrac><mrow><msub><mi>E</mi><mrow><mi>S</mi><mi>h</mi><mi>i</mi><mi>f</mi><mi>t</mi></mrow></msub><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo></mrow><mrow><msub><mi>P</mi><mrow><mi>c</mi><mi>h</mi><mo>,</mo><mi>a</mi><mi>v</mi><mi>g</mi></mrow></msub><mo>⋅</mo><mi>d</mi><mi>t</mi></mrow></mfrac></mtd></mtr><mtr><mtd columnalign="right"><msub><mi>n</mi><mi>b</mi></msub><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo></mtd><mtd columnalign="left"><mo>≥</mo><mfrac><mrow><msub><mi>P</mi><mrow><mi>S</mi><mi>h</mi><mi>i</mi><mi>f</mi><mi>t</mi></mrow></msub><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo><mo>⋅</mo><mi>d</mi><mi>t</mi></mrow><mrow><msub><mi>P</mi><mrow><mi>c</mi><mi>h</mi><mo>,</mo><mi>a</mi><mi>v</mi><mi>g</mi></mrow></msub><mo>⋅</mo><mi>d</mi><mi>t</mi></mrow></mfrac></mtd></mtr><mtr><mtd columnalign="right"><msub><mi>n</mi><mi>b</mi></msub><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo></mtd><mtd columnalign="left"><mo>≥</mo><mn>0</mn></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{align} t_{wait}(k) &amp;\geq dt \cdot (n_a(k) +n_b(k))\\ n_a(k) &amp;\geq \frac{E_{Shift}(k)}{P_{ch,avg} \cdot dt} \\ n_b(k) &amp;\geq \frac{P_{Shift}(k)\cdot dt}{P_{ch,avg}\cdot dt}\\ n_b(k) &amp;\geq 0 \end{align}</annotation></semantics></math></p>
<p><strong>draft result</strong>: It seems like the economical value of waiting time is higher opposed to demand charges and btms cost. For example, for a waiting time cost of 1<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>/</mi><mi>h</mi><mi>o</mi><mi>u</mi><mi>r</mi><mo>,</mo><mi>a</mi><mi>d</mi><mi>e</mi><mi>m</mi><mi>a</mi><mi>n</mi><mi>d</mi><mi>c</mi><mi>h</mi><mi>a</mi><mi>r</mi><mi>g</mi><mi>e</mi><mi>o</mi><mi>f</mi><mn>20</mn></mrow><annotation encoding="application/x-tex">/hour, a demand charge of 20</annotation></semantics></math>/kW, a BTMS cost of 200<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>/</mi><mi>k</mi><mi>W</mi><mi>h</mi><mi>f</mi><mi>o</mi><mi>r</mi><mn>5000</mn><mi>c</mi><mi>y</mi><mi>c</mi><mi>l</mi><mi>e</mi><mi>s</mi><mo>,</mo><mi>a</mi><mi>n</mi><mi>d</mi><mi>a</mi><mi>n</mi><mi>e</mi><mi>l</mi><mi>e</mi><mi>c</mi><mi>t</mi><mi>r</mi><mi>i</mi><mi>c</mi><mi>i</mi><mi>t</mi><mi>y</mi><mi>p</mi><mi>r</mi><mi>i</mi><mi>c</mi><mi>e</mi><mi>o</mi><mi>f</mi><mn>0.15</mn></mrow><annotation encoding="application/x-tex">/kWh for 5000 cycles, and an electricity price of 0.15</annotation></semantics></math>/kWh with an BTMS efficiency of 90%, no waiting time is considered to reduce the other factors. Only for BTMS prices of over 500$/kWh for 5000 cycles, small amounts of waiting times are considered. This preliminary result should be cross checked with more BEAM-simulation results and correct infrastructure settings, but the preliminary results show that waiting time are probably economical to avoid.</p>
<h2 id="level-short-horizoned-model-predictive-control">3. Level: short horizoned model predictive control</h2>
<p>based on the preliminary finding from the previous controller, we don’t design a MPC with a sophisticated wait time integration, i.e. we will just introduce one slack variable to maintain a feasible solution for all cases, if power demand of charging can’t be satisfied with avaialble grid and charging power resources. This is only necessary for the stand-alone version.</p>
<p>In order to align with the goal to show how control can benefit on keeping the stress low for the electric grid, we choose the objective to be a minimization of deviations of the grid power from the average.</p>
<p>in <em>step()</em>: <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable><mtr><mtd columnalign="right"><mo>min</mo><mspace width="1.0em"></mspace><msubsup><mi>Σ</mi><mrow><mi>k</mi><mo>=</mo><mo>−</mo><mn>1</mn></mrow><mi>N</mi></msubsup><mo stretchy="false" form="prefix">(</mo><msub><mi>P</mi><mrow><mi>G</mi><mi>r</mi><mi>i</mi><mi>d</mi></mrow></msub><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo><mo>−</mo><msub><mi>P</mi><mrow><mi>a</mi><mi>v</mi><mi>g</mi></mrow></msub><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo><msup><mo stretchy="false" form="postfix">)</mo><mn>2</mn></msup><mo>+</mo><msubsup><mi>Σ</mi><mrow><mi>k</mi><mo>=</mo><mn>0</mn></mrow><mi>N</mi></msubsup><msub><mi>M</mi><mn>1</mn></msub><msubsup><mi>t</mi><mn>1</mn><mn>2</mn></msubsup><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo><mo>+</mo><msubsup><mi>Σ</mi><mrow><mi>k</mi><mo>=</mo><mn>1</mn></mrow><mrow><mi>N</mi><mo>+</mo><mn>1</mn></mrow></msubsup><msub><mi>M</mi><mn>2</mn></msub><msubsup><mi>t</mi><mn>2</mn><mn>2</mn></msubsup><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{equation} \begin{aligned} \min \quad \Sigma_{k=-1}^{N} (P_{Grid}(k) - P_{avg}(k))^2 + \Sigma_{k=0}^{N} M_1 t_1^2(k) + \Sigma_{k=1}^{N+1} M_2 t_2^2(k) \end{aligned} \end{equation}</annotation></semantics></math></p>
<p>Here, <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>N</mi><annotation encoding="application/x-tex">N</annotation></semantics></math> is the prediction horizon of the short horizoned MPC, <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>M</mi><mn>1</mn></msub><annotation encoding="application/x-tex">M_1</annotation></semantics></math> and <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>M</mi><mn>2</mn></msub><annotation encoding="application/x-tex">M_2</annotation></semantics></math> are big numbers and <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>t</mi><mn>1</mn></msub><annotation encoding="application/x-tex">t_1</annotation></semantics></math> and <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>t</mi><mn>2</mn></msub><annotation encoding="application/x-tex">t_2</annotation></semantics></math> are slack variables to maintain feasibility for infeasible combinations of variable sets. We also include the last power withdrawal <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>P</mi><mrow><mi>G</mi><mi>r</mi><mi>i</mi><mi>d</mi></mrow></msub><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo>=</mo><mo>−</mo><mn>1</mn><mo stretchy="false" form="postfix">)</mo></mrow><annotation encoding="application/x-tex">P_{Grid}(k=-1)</annotation></semantics></math> from the grid to avoid big jumps.</p>
<p>subject to: <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable><mtr><mtd columnalign="right"><msub><mi>E</mi><mrow><mi>B</mi><mi>T</mi><mi>M</mi><mi>S</mi></mrow></msub><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo>+</mo><mn>1</mn><mo stretchy="false" form="postfix">)</mo></mtd><mtd columnalign="left"><mo>=</mo><msub><mi>E</mi><mrow><mi>B</mi><mi>T</mi><mi>M</mi><mi>S</mi></mrow></msub><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo><mo>+</mo><mi>d</mi><mi>t</mi><mo>⋅</mo><mo stretchy="false" form="prefix">(</mo><mi>η</mi><mo>⋅</mo><msub><mi>P</mi><mrow><mi>B</mi><mi>T</mi><mi>M</mi><mi>S</mi><mo>,</mo><mi>C</mi><mi>h</mi></mrow></msub><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo><mo>+</mo><mfrac><mn>1</mn><mi>η</mi></mfrac><msub><mi>P</mi><mrow><mi>B</mi><mi>T</mi><mi>M</mi><mi>S</mi><mo>,</mo><mi>D</mi><mi>C</mi><mi>h</mi></mrow></msub><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo><mo stretchy="false" form="postfix">)</mo><mspace width="1.0em"></mspace></mtd><mtd columnalign="right"><mo>∀</mo><mi>k</mi><mo>∈</mo><mo stretchy="false" form="prefix">[</mo><mn>0</mn><mo>,</mo><mi>N</mi><mo stretchy="false" form="postfix">]</mo></mtd></mtr><mtr><mtd columnalign="right"><msub><mi>E</mi><mi>V</mi></msub><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo>+</mo><mn>1</mn><mo stretchy="false" form="postfix">)</mo></mtd><mtd columnalign="left"><mo>=</mo><msub><mi>E</mi><mi>V</mi></msub><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo><mo>+</mo><mi>d</mi><mi>t</mi><mo>⋅</mo><msub><mi>P</mi><mrow><mi>C</mi><mi>h</mi><mi>a</mi><mi>r</mi><mi>g</mi><mi>e</mi></mrow></msub><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo><mspace width="1.0em"></mspace></mtd><mtd columnalign="right"><mo>∀</mo><mi>k</mi><mo>∈</mo><mo stretchy="false" form="prefix">[</mo><mn>0</mn><mo>,</mo><mi>N</mi><mo stretchy="false" form="postfix">]</mo></mtd></mtr><mtr><mtd columnalign="right"><msub><mi>P</mi><mrow><mi>C</mi><mi>h</mi><mi>a</mi><mi>r</mi><mi>g</mi><mi>e</mi></mrow></msub><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo></mtd><mtd columnalign="left"><mo>=</mo><msub><mi>P</mi><mrow><mi>G</mi><mi>r</mi><mi>i</mi><mi>d</mi></mrow></msub><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo><mo>−</mo><msub><mi>P</mi><mrow><mi>B</mi><mi>T</mi><mi>M</mi><mi>S</mi></mrow></msub><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo><mspace width="1.0em"></mspace></mtd><mtd columnalign="right"><mo>∀</mo><mi>k</mi><mo>∈</mo><mo stretchy="false" form="prefix">[</mo><mn>0</mn><mo>,</mo><mi>N</mi><mo stretchy="false" form="postfix">]</mo></mtd></mtr><mtr><mtd columnalign="right"><msub><mi>P</mi><mrow><mi>B</mi><mi>T</mi><mi>M</mi><mi>S</mi></mrow></msub><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo></mtd><mtd columnalign="left"><mo>=</mo><msub><mi>P</mi><mrow><mi>B</mi><mi>T</mi><mi>M</mi><mi>S</mi><mo>,</mo><mi>C</mi><mi>h</mi></mrow></msub><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo><mo>+</mo><msub><mi>P</mi><mrow><mi>B</mi><mi>T</mi><mi>M</mi><mi>S</mi><mo>,</mo><mi>D</mi><mi>C</mi><mi>h</mi></mrow></msub><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo><mspace width="1.0em"></mspace></mtd><mtd columnalign="right"><mo>∀</mo><mi>k</mi><mo>∈</mo><mo stretchy="false" form="prefix">[</mo><mn>0</mn><mo>,</mo><mi>N</mi><mo stretchy="false" form="postfix">]</mo></mtd></mtr><mtr><mtd columnalign="right"><msub><mi>P</mi><mrow><mi>G</mi><mi>r</mi><mi>i</mi><mi>d</mi></mrow></msub><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo></mtd><mtd columnalign="left"><mo>≤</mo><mo>max</mo><mo stretchy="false" form="prefix">(</mo><msub><mi>P</mi><mrow><mi>G</mi><mi>r</mi><mi>i</mi><mi>d</mi><mo>,</mo><mi>p</mi><mi>l</mi><mi>a</mi><mi>n</mi><mi>n</mi><mi>i</mi><mi>n</mi><mi>g</mi></mrow></msub><mo stretchy="false" form="prefix">(</mo><mi>i</mi><mo stretchy="false" form="postfix">)</mo><mo stretchy="false" form="postfix">)</mo><mo>+</mo><msub><mi>t</mi><mn>2</mn></msub><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo><mspace width="1.0em"></mspace></mtd><mtd columnalign="right"><mo>∀</mo><mi>k</mi><mo>∈</mo><mo stretchy="false" form="prefix">[</mo><mn>0</mn><mo>,</mo><mi>N</mi><mo stretchy="false" form="postfix">]</mo></mtd></mtr><mtr><mtd columnalign="right"><msub><mi>P</mi><mrow><mi>G</mi><mi>r</mi><mi>i</mi><mi>d</mi></mrow></msub><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo></mtd><mtd columnalign="left"><mo>≤</mo><msub><mi>P</mi><mrow><mi>G</mi><mi>r</mi><mi>i</mi><mi>d</mi><mo>,</mo><mi>D</mi><mi>E</mi><mi>R</mi><mi>M</mi><mi>S</mi></mrow></msub><mspace width="1.0em"></mspace></mtd><mtd columnalign="right"><mo>∀</mo><mi>k</mi><mo>∈</mo><mo stretchy="false" form="prefix">[</mo><mn>0</mn><mo>,</mo><mi>N</mi><mo stretchy="false" form="postfix">]</mo></mtd></mtr><mtr><mtd columnalign="right"><msub><mi>P</mi><mrow><mi>B</mi><mi>T</mi><mi>M</mi><mi>S</mi><mo>,</mo><mi>C</mi><mi>h</mi></mrow></msub><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo></mtd><mtd columnalign="left"><mo>≥</mo><mn>0</mn><mspace width="1.0em"></mspace></mtd><mtd columnalign="right"><mo>∀</mo><mi>k</mi><mo>∈</mo><mo stretchy="false" form="prefix">[</mo><mn>0</mn><mo>,</mo><mi>N</mi><mo stretchy="false" form="postfix">]</mo></mtd></mtr><mtr><mtd columnalign="right"><msub><mi>P</mi><mrow><mi>B</mi><mi>T</mi><mi>M</mi><mi>S</mi><mo>,</mo><mi>D</mi><mi>C</mi><mi>h</mi></mrow></msub><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo></mtd><mtd columnalign="left"><mo>≤</mo><mn>0</mn><mspace width="1.0em"></mspace></mtd><mtd columnalign="right"><mo>∀</mo><mi>k</mi><mo>∈</mo><mo stretchy="false" form="prefix">[</mo><mn>0</mn><mo>,</mo><mi>N</mi><mo stretchy="false" form="postfix">]</mo></mtd></mtr><mtr><mtd columnalign="right"><msub><mi>P</mi><mrow><mi>C</mi><mi>h</mi><mi>a</mi><mi>r</mi><mi>g</mi><mi>e</mi></mrow></msub><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo></mtd><mtd columnalign="left"><mo>≥</mo><mn>0</mn><mspace width="1.0em"></mspace></mtd><mtd columnalign="right"><mo>∀</mo><mi>k</mi><mo>∈</mo><mo stretchy="false" form="prefix">[</mo><mn>0</mn><mo>,</mo><mi>N</mi><mo stretchy="false" form="postfix">]</mo></mtd></mtr><mtr><mtd columnalign="right"><msub><mi>t</mi><mn>1</mn></msub><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo></mtd><mtd columnalign="left"><mo>≥</mo><mn>0</mn><mspace width="1.0em"></mspace></mtd><mtd columnalign="right"><mo>∀</mo><mi>k</mi><mo>∈</mo><mo stretchy="false" form="prefix">[</mo><mn>0</mn><mo>,</mo><mi>N</mi><mo stretchy="false" form="postfix">]</mo></mtd></mtr><mtr><mtd columnalign="right"><msub><mi>t</mi><mn>2</mn></msub><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo></mtd><mtd columnalign="left"><mo>≥</mo><mn>0</mn><mspace width="1.0em"></mspace></mtd><mtd columnalign="right"><mo>∀</mo><mi>k</mi><mo>∈</mo><mo stretchy="false" form="prefix">[</mo><mn>0</mn><mo>,</mo><mi>N</mi><mo stretchy="false" form="postfix">]</mo></mtd></mtr><mtr><mtd columnalign="right"><msub><mi>E</mi><mrow><mi>B</mi><mi>T</mi><mi>M</mi><mi>S</mi></mrow></msub><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo></mtd><mtd columnalign="left"><mo>≥</mo><mn>0</mn><mspace width="1.0em"></mspace></mtd><mtd columnalign="right"><mo>∀</mo><mi>k</mi><mo>∈</mo><mo stretchy="false" form="prefix">[</mo><mn>0</mn><mo>,</mo><mi>N</mi><mo>+</mo><mn>1</mn><mo stretchy="false" form="postfix">]</mo></mtd></mtr><mtr><mtd columnalign="right"><msub><mi>E</mi><mrow><mi>B</mi><mi>T</mi><mi>M</mi><mi>S</mi></mrow></msub><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo></mtd><mtd columnalign="left"><mo>≤</mo><mi>Δ</mi><msub><mi>E</mi><mrow><mi>B</mi><mi>T</mi><mi>M</mi><mi>S</mi></mrow></msub><mspace width="1.0em"></mspace></mtd><mtd columnalign="right"><mo>∀</mo><mi>k</mi><mo>∈</mo><mo stretchy="false" form="prefix">[</mo><mn>0</mn><mo>,</mo><mi>N</mi><mo>+</mo><mn>1</mn><mo stretchy="false" form="postfix">]</mo></mtd></mtr><mtr><mtd columnalign="right"><msub><mi>E</mi><mrow><mi>B</mi><mi>T</mi><mi>M</mi><mi>S</mi></mrow></msub><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo></mtd><mtd columnalign="left"><mo>≥</mo><msub><mi>E</mi><mrow><mi>B</mi><mi>T</mi><mi>M</mi><mi>S</mi><mo>,</mo><mi>l</mi><mi>o</mi><mi>w</mi><mi>e</mi><mi>r</mi></mrow></msub><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo><mspace width="1.0em"></mspace></mtd><mtd columnalign="right"><mo>∀</mo><mi>k</mi><mo>∈</mo><mo stretchy="false" form="prefix">[</mo><mn>1</mn><mo>,</mo><mi>N</mi><mo>+</mo><mn>1</mn><mo stretchy="false" form="postfix">]</mo></mtd></mtr><mtr><mtd columnalign="right"><msub><mi>E</mi><mrow><mi>B</mi><mi>T</mi><mi>M</mi><mi>S</mi></mrow></msub><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo></mtd><mtd columnalign="left"><mo>≤</mo><msub><mi>E</mi><mrow><mi>B</mi><mi>T</mi><mi>M</mi><mi>S</mi><mo>,</mo><mi>u</mi><mi>p</mi><mi>p</mi><mi>e</mi><mi>r</mi></mrow></msub><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo><mspace width="1.0em"></mspace></mtd><mtd columnalign="right"><mo>∀</mo><mi>k</mi><mo>∈</mo><mo stretchy="false" form="prefix">[</mo><mn>1</mn><mo>,</mo><mi>N</mi><mo>+</mo><mn>1</mn><mo stretchy="false" form="postfix">]</mo></mtd></mtr><mtr><mtd columnalign="right"><msub><mi>E</mi><mi>V</mi></msub><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo></mtd><mtd columnalign="left"><mo>≥</mo><msub><mi>E</mi><mrow><mi>V</mi><mo>,</mo><mi>l</mi><mi>o</mi><mi>w</mi><mi>e</mi><mi>r</mi></mrow></msub><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo><mo>−</mo><msub><mi>t</mi><mn>1</mn></msub><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo><mspace width="1.0em"></mspace></mtd><mtd columnalign="right"><mo>∀</mo><mi>k</mi><mo>∈</mo><mo stretchy="false" form="prefix">[</mo><mn>1</mn><mo>,</mo><mi>N</mi><mo>+</mo><mn>1</mn><mo stretchy="false" form="postfix">]</mo></mtd></mtr><mtr><mtd columnalign="right"><msub><mi>E</mi><mi>V</mi></msub><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo></mtd><mtd columnalign="left"><mo>≤</mo><msub><mi>E</mi><mrow><mi>V</mi><mo>,</mo><mi>u</mi><mi>p</mi><mi>p</mi><mi>e</mi><mi>r</mi></mrow></msub><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo><mspace width="1.0em"></mspace></mtd><mtd columnalign="right"><mo>∀</mo><mi>k</mi><mo>∈</mo><mo stretchy="false" form="prefix">[</mo><mn>1</mn><mo>,</mo><mi>N</mi><mo>+</mo><mn>1</mn><mo stretchy="false" form="postfix">]</mo></mtd></mtr><mtr><mtd columnalign="right"><msub><mi>E</mi><mrow><mi>B</mi><mi>T</mi><mi>M</mi><mi>S</mi></mrow></msub><mo stretchy="false" form="prefix">(</mo><mn>0</mn><mo stretchy="false" form="postfix">)</mo></mtd><mtd columnalign="left"><mo>=</mo><msub><mi>E</mi><mrow><mi>B</mi><mi>T</mi><mi>M</mi><mi>S</mi><mo>,</mo><mi>P</mi><mi>h</mi><mi>y</mi><mi>S</mi><mi>i</mi><mi>m</mi></mrow></msub></mtd></mtr><mtr><mtd columnalign="right"><msub><mi>E</mi><mi>V</mi></msub><mo stretchy="false" form="prefix">(</mo><mn>0</mn><mo stretchy="false" form="postfix">)</mo></mtd><mtd columnalign="left"><mo>=</mo><mn>0</mn></mtd></mtr><mtr><mtd columnalign="right"><msub><mi>P</mi><mrow><mi>a</mi><mi>v</mi><mi>g</mi></mrow></msub></mtd><mtd columnalign="left"><mo>=</mo><msubsup><mi>Σ</mi><mrow><mi>k</mi><mo>=</mo><mo>−</mo><mn>1</mn></mrow><mi>N</mi></msubsup><mfrac><mrow><msub><mi>P</mi><mrow><mi>G</mi><mi>r</mi><mi>i</mi><mi>d</mi></mrow></msub><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo></mrow><mrow><mi>N</mi><mo>+</mo><mn>1</mn></mrow></mfrac></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{align} E_{BTMS}(k+1) &amp;= E_{BTMS}(k) + dt \cdot (\eta \cdot P_{BTMS,Ch}(k) + \frac{1}{\eta}P_{BTMS,DCh}(k)) \quad &amp;\forall k \in [0,N]\\ E_{V}(k+1) &amp;= E_{V}(k) + dt \cdot P_{Charge}(k) \quad &amp;\forall k \in [0,N]\\ P_{Charge}(k) &amp;= P_{Grid}(k) - P_{BTMS}(k) \quad &amp;\forall k \in [0,N] \\ P_{BTMS}(k) &amp;= P_{BTMS,Ch}(k) + P_{BTMS,DCh}(k) \quad &amp;\forall k \in [0,N]\\ P_{Grid}(k) &amp;\leq \max (P_{Grid,planning}(i)) + t_2(k) \quad &amp;\forall k \in [0,N]\\ P_{Grid}(k) &amp;\leq P_{Grid,DERMS} \quad &amp;\forall k \in [0,N]\\ P_{BTMS,Ch}(k) &amp;\geq 0 \quad &amp;\forall k \in [0,N]\\ P_{BTMS,DCh}(k) &amp;\leq 0 \quad &amp;\forall k \in [0,N]\\ P_{Charge}(k) &amp;\geq 0 \quad &amp;\forall k \in [0,N]\\ t_1(k) &amp;\geq 0 \quad &amp;\forall k \in [0,N]\\ t_2(k) &amp;\geq 0 \quad &amp;\forall k \in [0,N]\\ E_{BTMS}(k) &amp;\geq 0 \quad &amp;\forall k \in [0,N+1]\\ E_{BTMS}(k) &amp;\leq \Delta E_{BTMS} \quad &amp;\forall k \in [0,N+1] \\ E_{BTMS}(k) &amp;\geq E_{BTMS,lower}(k) \quad &amp;\forall k \in [1,N+1]\\ E_{BTMS}(k) &amp;\leq E_{BTMS,upper}(k) \quad &amp;\forall k \in [1,N+1]\\ E_{V}(k) &amp;\geq E_{V,lower}(k) - t_1(k) \quad &amp;\forall k \in [1,N+1]\\ E_{V}(k) &amp;\leq E_{V,upper}(k) \quad &amp;\forall k \in [1,N+1]\\ E_{BTMS}(0) &amp;= E_{BTMS,PhySim}\\ E_{V}(0) &amp;= 0 \\ P_{avg} &amp;= \Sigma_{k=-1}^{N} \frac{P_{Grid}(k)}{N+1} \end{align}</annotation></semantics></math></p>
<p>Compared to the fomulations before, <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>P</mi><mrow><mi>C</mi><mi>h</mi><mi>a</mi><mi>r</mi><mi>g</mi><mi>e</mi></mrow></msub><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo></mrow><annotation encoding="application/x-tex">P_{Charge}(k)</annotation></semantics></math> is now a variable determined to satisfy the charging demand for Vehicles <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>E</mi><mrow><mi>V</mi><mo>,</mo><mi>l</mi><mi>o</mi><mi>w</mi><mi>e</mi><mi>r</mi></mrow></msub><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo></mrow><annotation encoding="application/x-tex">E_{V,lower}(k)</annotation></semantics></math> and <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>E</mi><mrow><mi>V</mi><mo>,</mo><mi>u</mi><mi>p</mi><mi>p</mi><mi>e</mi><mi>r</mi></mrow></msub><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo></mrow><annotation encoding="application/x-tex">E_{V,upper}(k)</annotation></semantics></math>, which are determined as the sum of the vehicle object function <em>determineChargingTrajectory()</em>. The function returns an upper and lower bound for the necessary energy transfered to each vehicle. The lower bound is a trajectory which need to be fullfilled to reach the desired end in time, the upper bound is a trajectory which resemble the fastet possible charge. The time in between is allowed flexibility. Likewise, we added a differntial equaiton for the aggregated energy level in the vehicles <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>E</mi><mi>V</mi></msub><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo></mrow><annotation encoding="application/x-tex">E_{V}(k)</annotation></semantics></math>.<br />
We added the slack variable <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>t</mi><mn>1</mn></msub><annotation encoding="application/x-tex">t_1</annotation></semantics></math> to the minimal needed energy to maintain feasibility for all cases, i.e. by delaying the charge of a vehicle. Feasibility can also by maintained by exceeding the power limit <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>max</mo><mo stretchy="false" form="prefix">(</mo><msub><mi>P</mi><mrow><mi>G</mi><mi>r</mi><mi>i</mi><mi>d</mi><mo>,</mo><mi>p</mi><mi>l</mi><mi>a</mi><mi>n</mi><mi>n</mi><mi>i</mi><mi>n</mi><mi>g</mi></mrow></msub><mo stretchy="false" form="prefix">(</mo><mi>i</mi><mo stretchy="false" form="postfix">)</mo><mo stretchy="false" form="postfix">)</mo></mrow><annotation encoding="application/x-tex">\max (P_{Grid,planning}(i))</annotation></semantics></math> from planning, which is penalized by the slack variable <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>t</mi><mn>2</mn></msub><annotation encoding="application/x-tex">t_2</annotation></semantics></math>. By weighing the values of <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>M</mi><mn>1</mn></msub><annotation encoding="application/x-tex">M_1</annotation></semantics></math> and <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>M</mi><mn>2</mn></msub><annotation encoding="application/x-tex">M_2</annotation></semantics></math> against each other, one of both feasiblity sustaining methods can be favoured.<br />
The charging power <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>P</mi><mrow><mi>C</mi><mi>h</mi><mi>a</mi><mi>r</mi><mi>g</mi><mi>e</mi></mrow></msub><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo></mrow><annotation encoding="application/x-tex">P_{Charge}(k)</annotation></semantics></math> should be distributed by the charging desire of each vehicle. (sharing power doesn’t make sense to reduce average waiting times, see this one paper)</p>
<p>We initialize each run of the short horizoned MPC with the energy level of the BTMS, which will be given from the physical simulation.</p>
<p>To summarize the variables, we have: <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable><mtr><mtd columnalign="right"><mi>x</mi><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo></mtd><mtd columnalign="left"><mo>=</mo><mo stretchy="false" form="prefix">[</mo><msub><mi>E</mi><mrow><mi>B</mi><mi>T</mi><mi>M</mi><mi>S</mi></mrow></msub><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo><mo>,</mo><msub><mi>E</mi><mi>V</mi></msub><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo><mo stretchy="false" form="postfix">]</mo></mtd></mtr><mtr><mtd columnalign="right"><mi>u</mi><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo></mtd><mtd columnalign="left"><mo>=</mo><mo stretchy="false" form="prefix">[</mo><msub><mi>P</mi><mrow><mi>G</mi><mi>r</mi><mi>i</mi><mi>d</mi></mrow></msub><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo><mo>,</mo><msub><mi>P</mi><mrow><mi>B</mi><mi>T</mi><mi>M</mi><mi>S</mi></mrow></msub><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo><mo>,</mo><msub><mi>P</mi><mrow><mi>B</mi><mi>T</mi><mi>M</mi><mi>S</mi><mo>,</mo><mi>C</mi><mi>h</mi></mrow></msub><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo><mo>,</mo><msub><mi>P</mi><mrow><mi>B</mi><mi>T</mi><mi>M</mi><mi>S</mi><mo>,</mo><mi>D</mi><mi>C</mi><mi>h</mi></mrow></msub><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo><mo>,</mo><msub><mi>P</mi><mrow><mi>C</mi><mi>h</mi><mi>a</mi><mi>r</mi><mi>g</mi><mi>e</mi></mrow></msub><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo><mo stretchy="false" form="postfix">]</mo></mtd></mtr><mtr><mtd columnalign="right"><msub><mi>t</mi><mn>1</mn></msub><mo>,</mo><msub><mi>t</mi><mn>2</mn></msub></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{align} x(k) &amp;= [E_{BTMS}(k), E_{V}(k)]\\ u(k) &amp;= [P_{Grid}(k), P_{BTMS}(k), P_{BTMS,Ch}(k), P_{BTMS,DCh}(k), P_{Charge}(k)] \\ t_1, t_2 \end{align}</annotation></semantics></math> inputs to our algortihm are <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable><mtr><mtd columnalign="right"></mtd><mtd columnalign="left"><msub><mi>P</mi><mrow><mi>G</mi><mi>r</mi><mi>i</mi><mi>d</mi></mrow></msub><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo>=</mo><mo>−</mo><mn>1</mn><mo stretchy="false" form="postfix">)</mo><mo>,</mo><mo>max</mo><mo stretchy="false" form="prefix">(</mo><msub><mi>P</mi><mrow><mi>G</mi><mi>r</mi><mi>i</mi><mi>d</mi><mo>,</mo><mi>p</mi><mi>l</mi><mi>a</mi><mi>n</mi><mi>n</mi><mi>i</mi><mi>n</mi><mi>g</mi><mo stretchy="false" form="prefix">(</mo><mi>i</mi><mo stretchy="false" form="postfix">)</mo></mrow></msub><mo stretchy="false" form="postfix">)</mo><mo>,</mo><msub><mi>P</mi><mrow><mi>G</mi><mi>r</mi><mi>i</mi><mi>d</mi><mo>,</mo><mi>D</mi><mi>E</mi><mi>R</mi><mi>M</mi><mi>S</mi></mrow></msub><mo>,</mo><mi>Δ</mi><msub><mi>E</mi><mrow><mi>B</mi><mi>T</mi><mi>M</mi><mi>S</mi></mrow></msub><mo>,</mo></mtd></mtr><mtr><mtd columnalign="right"></mtd><mtd columnalign="left"><msub><mi>E</mi><mrow><mi>B</mi><mi>T</mi><mi>M</mi><mi>S</mi><mo>,</mo><mi>l</mi><mi>o</mi><mi>w</mi><mi>e</mi><mi>r</mi></mrow></msub><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo><mo>,</mo><msub><mi>E</mi><mrow><mi>B</mi><mi>T</mi><mi>M</mi><mi>S</mi><mo>,</mo><mi>u</mi><mi>p</mi><mi>p</mi><mi>e</mi><mi>r</mi></mrow></msub><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo><mo>,</mo><msub><mi>E</mi><mrow><mi>V</mi><mo>,</mo><mi>l</mi><mi>o</mi><mi>w</mi><mi>e</mi><mi>r</mi></mrow></msub><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo><mo>,</mo><msub><mi>E</mi><mrow><mi>V</mi><mo>,</mo><mi>u</mi><mi>p</mi><mi>p</mi><mi>e</mi><mi>r</mi></mrow></msub><mo stretchy="false" form="prefix">(</mo><mi>k</mi><mo stretchy="false" form="postfix">)</mo><mo>,</mo><msub><mi>E</mi><mrow><mi>B</mi><mi>T</mi><mi>M</mi><mi>S</mi><mo>,</mo><mi>P</mi><mi>h</mi><mi>y</mi><mi>S</mi><mi>i</mi><mi>m</mi></mrow></msub></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{align} &amp;P_{Grid}(k=-1), \max({P_{Grid,planning(i)}}), P_{Grid,DERMS}, \Delta E_{BTMS},\\ &amp;E_{BTMS,lower}(k), E_{BTMS,upper}(k), E_{V,lower}(k), E_{V,upper}(k), E_{BTMS,PhySim} \end{align}</annotation></semantics></math></p>
</body>
</html>
